---
layout: post
title: 자바 병렬 프로그래밍 8장 스레드 풀 활용
---
# 8장 스레드 풀 활용

## 8.1 작업과 실행 정책 간의 보이지 않는 연결 관계

### 8.1.1 스레드 부족 데드락

스레드 풀에서 다른 작업에 의존성을 갖고 있는 작업을 실행시킨다면 데드락에 걸릴 가능성이 높다.
단일 스레드로 동작하는 Executor에서 다른 작업을 큐에 등록하고 해당 작업이 실행된 결과를 가져다 사용하는 작업을 실행하면, 데드락이 제대로 걸린다.

## 8.2 스레드 풀 크기 조절

스레드 풀의 가장 이상적인 크기는 스레드 풀에서 실행할 작업의 종류와 스레드 풀을 활용할 애플리케이션의 특성에 따라 결정된다.
스레드 풀의 크기를 하드코딩해 고정시키는 것은 그다지 좋은 방법이 아니며, 스레드 풀의 크기는 설정 파일이나 Runtime.availableProcessors 등의 메소드 결과 값에 따라 동적으로 지정되도록 해야 한다.

CPU를 많이 사용하는 작업의 경우 N개의 CPU를 탑재하고 있는 하드웨어에서 스레드 풀을 사용할 때는 스레드의 개수를 N+1개로 맞추면 최적의 성능을 발휘한다고 알려져있다. (CPU를 많이 사용하는 스레드에서도 페이징 오류가 발생하거나 기타 여러 가지 원인으로 인해 스레드가 멈추는 경우가 있기 때문에 1개의 추가 스레드를 마련해 두면 스레드 가운데 하나에 문제가 발생했을 때 CPU가 쉬지 않고 계속해서 일을 할 수 있다.)

## 8.3 ThreadPoolExecutor 설정

### 8.3.1 스레드 생성과 제거

* 스레드 풀 클래스는 실행할 작업이 없다 하더라도 스레드의 개수를 최대한 코어 크기에 맞추도록 되어있다.
* 큐에 작업이 가득 차지 않는 이상 스레드의 수가 코어 크기를 넘지 않는다.
* 풀의 최대 크기는 동시에 얼마나 많은 개수의 스레드가 동작할 수 있는지를 제한하는 최대 값이다.
* 지정한 스레드 유지 시간 이상 아무런 작업 없이 대기하고 있던 스레드는 제거 대상 목록에 올라가며, 풀의 스레드 개수가 코어 크기를 넘어설 때 제거될 수 있다.

---
newFixedThreadPool
* 스레드 풀의 코어 크기와 최대 크기를 newFixedThreadPool 메소드에 지정한 값으로 동일하게 지정
* 시간 제한은 무제한으로 설정

newCachedThreadPool
* 스레드 풀의 최대 크기를 Integer.MAX_VALUE 값으로 지정하고 코어 크기를 0으로 지정
* 스레드 유지 시간을 1분으로 지정

### 8.3.2 큐에 쌓인 작업 관리

ThreadPoolExecutor를 생성할 때 작업을 쌓아둘 큐로 BlockingQueue를 지정할 수 있다.

**스레드 풀에서 작업을 쌓아둘 큐에 적용할 수 있는 전략**
1. 큐의 크기 제한을 두지 않는 방법
2. 큐의 크기를 제한하는 방법
3. 작업을 스레드에게 직접 넘겨주는 방법

#### newFixedThreadPool / newSingleThreadExecutor
* 기본 설정으로 크기가 제한되지 않은 LinkedBlockingQueue를 사용한다.

스레드 개수가 굉장히 많거나 제한이 거의 없는 상태인 경우 작업을 큐에 쌓는 절차를 생략할 수 도 있는데, 이럴때는 SynchronouseQueue를 사용해 프로듀서에서 생성한 작업을 컨슈머인 스레드에게 `직접전달`할 수 있다.

#### newCachedThreadPool
* SynchronousQueue를 사용한다.

`스레드 풀에서 실행할 작업이 서로 독립적인 경우에만 스레드의 개수나 작업 큐의 크기를 제한할 수 있다.`

### 8.3.3 집중 대응 정책 (Saturation Policy)

크기가 제한된 큐에 작업이 가득 차면 집중 대응 정책이 동작한다.
ThreadPoolExecutor의 집중 대응 정책은 setRejectedExecutionHandler 메소드를 사용해 원하는 정책으로 변경할 수 있다.

**집중 대응 정책**
* 중단 정책 (AbortPolicy)
execute 메소드에서 RuntimeException을 상속받은 RejectedExecutionException을 던진다.
execute 메소드를 호출하는 스레드는 RejectedExecutionException을 잡아서 작업을 더 이상 추가할 수 없는 상황에 직접 대응해야 한다.
* 제거 정책 (DiscardPolicy)
큐에 작업을 더 이상 쌓을 수 없다면 방금 추가시키려고 했던 정책을 아무 반응 없이 제거해버린다.
* 오래된 항목 제거 (DiscardOldestPolicy)
큐에 쌓은 항목 중 가장 오래되어 다음 번에 실행될 예정이던 작업을 제거하고, 추가하고자 했던 작업을 큐에 다시 추가해본다.
* 호출자 실행 (CallerRunsPolicy)
작업을 제거하거나 예외를 던지지 않으면서 큐의 크기를 초과하는 작업을 프로듀서에게 거꾸로 넘겨 작업 추가 속도를 늦출 수 있도록 일종의 속도 조절 방법으로 사용된다.

### 8.3.4 스레드 팩토리

스레드 풀에서 새로운 스레드를 생성해야 할 시점이 되면, 새로운 스레드는 항상 스레드 팩토리를 통해 생성한다.
기본 값으로 설정된 스레드 팩토리에서는 데몬이 아니면서 아무런 설정도 변경하지 않은 새로운 스레드를 생성하도록 되어 있다.

스레드 팩토리를 직접 작성해 사용하는 경우로
1. 스레드 풀에서 사용하는 스레드에 UncaughtExceptionHandler를 직접 지정하고자 할 경우
2. Thread 클래스를 상속받은 또 다른 스레드를 생성해 사용하고자 하는 경우(디버깅을 위한 메시지를 출력하는 기능을 추가)
3. 스레드 풀에서 사용하는 스레드마다 의미가 있는 이름을 지정해 오류가 발생했을 때 나타나는 덤프 파일이나 직접 작성한 로그 파일에서 스레드 이름이 표시되도록 할 수도 있다.

### ThreadPoolExecutor 생성 이후 설정 변경

Executors 클래스에서 기본적으로 제공하는 여러 가지 메소드(newSingleThreadExecutor 메소드 제외)를 사용해 Executor를 생성한 경우 ThreadPoolExecutor로 형변환해 여러가지 set 메소드를 사용할 수 있다.
Executors에는 unconfigurableExecutorService 메소드가 있는데, 현재 만들어져 있는 ExecutorService를 넘겨 받은 다음 ExecutorService의 메소드만을 외부에 노출하고 나머지는 가리도록 한꺼풀 덮어 씌워 더 이상은 설정을 변경하지 못하도록 할 수 있다. (newSingleThreadExecutor)

## 8.4 ThreadPoolExecutor 상속

ThreadPoolExecutor는 beforeExecute, afterExecute, terminated와 같은 여러 가지 훅(hook)도 제공한다.

### 8.4.1 예제: 스레드 풀에 통계 확인 기능 추가

## 8.5 재귀 함수 병렬화

### 8.5.1 예제: 퍼즐 프레임웍
